---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/deployment.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: ext-auth-service
    
  name: ext-auth-service
  namespace: gloo-mesh-addons
---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/deployment.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    app: ext-auth-service
    
  name: ext-auth-service-signing-key
  namespace: gloo-mesh-addons
type: Opaque
data:
  signing-key: "WjlyNER3YndESA=="
---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ext-auth-service
  namespace: gloo-mesh-addons
  labels:
    app: ext-auth-service
    
rules:
- apiGroups:
  - extauth.solo.io
  resources:
  - authconfigs
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extauth.solo.io
  resources:
  - authconfigs/status
  verbs:
  - get
  - update
- apiGroups:
  - ""
  resources:
  - secrets
  - configmaps
  verbs:
  - get
  - list
  - watch
---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/rbac.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ext-auth-service
  namespace: gloo-mesh-addons
  labels:
    app: ext-auth-service
    
subjects:
- kind: ServiceAccount
  name: ext-auth-service
  namespace: gloo-mesh-addons
roleRef:
  kind: ClusterRole
  name: ext-auth-service
  apiGroup: rbac.authorization.k8s.io
---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/deployment.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: ext-auth-service
    
  name: ext-auth-service
  namespace: gloo-mesh-addons
spec:
  type: ClusterIP
  selector:
    app: ext-auth-service
  ports:
  - name: grpc
    port: 8083
  - name: debug
    port: 9091
  - name: health
    port: 8082
---
# Source: gloo-mesh-agent/charts/ext-auth-service/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: ext-auth-service
    
  name: ext-auth-service
  namespace: gloo-mesh-addons
spec:
  replicas: 4
  selector:
    matchLabels:
      app: ext-auth-service
  template:
    metadata:
      labels:
        app: ext-auth-service
      annotations:
        prometheus.io/path: /metrics
        prometheus.io/port: "9091"
        prometheus.io/scrape: "true"
        
        proxy.istio.io/config: "{ \"holdApplicationUntilProxyStarts\": true }"
    spec:
      nodeSelector:
        solo-poc: "addons"
      tolerations:
        - key: cloud.google.com/solo-poc
          operator: Equal
          value: "addons"
          effect: NoSchedule
      serviceAccountName: ext-auth-service
      containers:
      - image: "registry.hub.docker.com/ably77/ext-auth-service:amd64-ext-auth-service-0.35.0-poc"
        imagePullPolicy: IfNotPresent
        name: ext-auth-service
        env:
        - name: GOGC
          value: "2000"
        - name: LOG_LEVEL
          value: INFO
        - name: START_STATS_SERVER
          value: "true"
        - name: WATCH_NAMESPACE
          value: ""
        - name: SERVER_PORT
          value: "8083"
        - name: DEBUG_PORT
          value: "9091"
        - name: USER_ID_HEADER
          value: ""
        - name: PLUGIN_DIRECTORY
          value: "/auth-plugins/"
        - name: HEADERS_TO_REDACT
          value: "authorization"
        - name: HEALTH_FAIL_TIMEOUT
          value: "15"
        - name: HEALTH_HTTP_PORT
          value: "8082"
        - name: HEALTH_HTTP_PATH
          value: "/healthcheck"
        - name: HEALTH_LIVENESS_HTTP_PATH
          value: "/livenesscheck"
        - name: SIGNING_KEY
          valueFrom:
            secretKeyRef:
              name: ext-auth-service-signing-key
              key: signing-key
        readinessProbe:
          httpGet:
            port: 8082
            path: /healthcheck
          initialDelaySeconds: 1
          periodSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        livenessProbe:
            httpGet:
              port: 8082
              path: /livenesscheck
            initialDelaySeconds: 3
            periodSeconds: 10
            failureThreshold: 3
            successThreshold: 1
        resources:
          requests:
            cpu: 2000m
            memory: 1000Mi
        securityContext:
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
---